BUILD_MODE ?= debug
CC = gcc

SRC_DIR := src

# –í–∞–ª–∏–¥–∞—Ü–∏—è BUILD_MODE
ifeq ($(BUILD_MODE),debug)
	CFLAGS := -g
else ifeq ($(BUILD_MODE),release)
	CFLAGS := -O2
else
$(error ‚ùå –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π BUILD_MODE='$(BUILD_MODE)'. –ò—Å–ø–æ–ª—å–∑—É–π 'debug' –∏–ª–∏ 'release')
endif

OBJ_DIR := build/$(BUILD_MODE)
BIN_DIR := bin/$(BUILD_MODE)

# –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –æ–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
SRCS := $(wildcard $(SRC_DIR)/*.c)
OBJS := $(patsubst $(SRC_DIR)/%.c, $(OBJ_DIR)/%.o, $(SRCS))

TARGET := $(BIN_DIR)/app.exe

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
ifeq ($(COMPUTERNAME),CHAMION)
GREETING = @echo "–ü—Ä–∏–≤–µ—Ç, $(COMPUTERNAME), —Å–µ–π—á–∞—Å –±–∏–ª–¥–∏—Ç—å –±—É–¥—É..."
else
GREETING = @echo "–•–ê–ö–ï–† –ë–õ–Ø–¢–¨ –°–ë–ò–õ–î–ò–õ..."
endif

# –¶–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
build: check_build_mode $(TARGET)
	$(GREETING)

# –ù–æ–≤—ã–π —Ç–∞—Ä–≥–µ—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ä–µ–∂–∏–º–∞ –≤ –Ω–∞—á–∞–ª–µ
check_build_mode:
	@echo "üî® –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Å–±–æ—Ä–∫–∏: $(BUILD_MODE)"

$(TARGET): $(OBJS)
	@echo "üîß –õ–∏–Ω–∫—É–µ–º –æ–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã..."
	@mkdir -p $(BIN_DIR)
	$(CC) $(CFLAGS) -o $@ $^
	@echo "‚úÖ –ì–æ—Ç–æ–≤–æ: $@"

$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	@mkdir -p $(OBJ_DIR)
	$(CC) $(CFLAGS) -c $< -o $@

.PHONY: rebuild
rebuild: clean build
	@echo "üîÑ –ü—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω"

.PHONY: clean
clean:
	rm -rf build/*
	rm -rf bin/*
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
